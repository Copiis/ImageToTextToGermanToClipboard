// ==UserScript==
// @name         Image Text Reader and Translator to Clipboard (Google Translate)
// @namespace    http://tampermonkey.net/
// @version      0.9
// @description  Liest Text aus Bildern nach Klick, übersetzt ihn ins Deutsche und kopiert ihn in die Zwischenablage
// @author       Copiis
// @match        *://*/*
// @require      https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js
// @grant        GM_xmlhttpRequest
// @connect      translate.google.com
// ==/UserScript==

(function() {
    'use strict';

    // Funktion, um den Text von unerwünschten Zeichen zu bereinigen
    function cleanText(text) {
        return text.replace(/[^\x20-\x7E]/g, ' ').trim(); // Nur druckbare ASCII-Zeichen behalten
    }

    // Funktion, um Text aus einem Bild zu extrahieren, zu übersetzen und zu kopieren
    async function readAndTranslateTextOnClick(imgElement) {
        try {
            // Texterkennung starten
            const { data: { text } } = await Tesseract.recognize(imgElement.src, 'eng'); // Annahme: Originaltext in Englisch
            console.log("Erkannter Text:", text);

            if (!text) {
                alert("Kein Text erkannt. Bitte versuche es mit einem anderen Bild.");
                return;
            }

            // Text bereinigen
            const cleanedText = cleanText(text);
            if (!cleanedText) {
                alert("Der erkannte Text enthält keine gültigen Zeichen.");
                return;
            }

            // Text ins Deutsche übersetzen
            const translatedText = await translateText(cleanedText);  // Ziel: Deutsch
            console.log("Übersetzter Text:", translatedText);

            // Übersetzten Text in die Zwischenablage kopieren
            navigator.clipboard.writeText(translatedText).then(() => {
                alert("Übersetzter Text wurde in die Zwischenablage kopiert: " + translatedText);
            }).catch(err => {
                console.error("Fehler beim Kopieren in die Zwischenablage:", err);
            });
        } catch (error) {
            console.error("Fehler bei Texterkennung oder Übersetzung:", error);
            alert("Es ist ein Fehler aufgetreten. Bitte überprüfe die Konsole für Details.");
        }
    }

    // Funktion, um den Text über den Google Übersetzer zu übersetzen
    async function translateText(text) {
        const url = `https://translate.google.com/m?hl=de&sl=en&tl=de&ie=UTF-8&prev=_m&q=${encodeURIComponent(text)}`;

        return new Promise((resolve, reject) => {
            GM_xmlhttpRequest({
                method: "GET",
                url: url,
                onload: function(response) {
                    if (response.status === 200) {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(response.responseText, "text/html");
                        const translationElement = doc.querySelector(".result-container"); // CSS-Klasse des übersetzten Textes

                        if (translationElement) {
                            resolve(translationElement.innerText);
                        } else {
                            reject("Übersetzung nicht gefunden.");
                        }
                    } else {
                        reject("Fehler beim Zugriff auf die Google Übersetzer-Seite.");
                    }
                },
                onerror: function() {
                    reject("Netzwerkfehler beim Zugriff auf die Google Übersetzer-Seite.");
                }
            });
        });
    }

    // Füge Klick-Event nur einmalig für jedes Bild hinzu
    document.querySelectorAll('img').forEach(img => {
        img.addEventListener('click', () => readAndTranslateTextOnClick(img));  // Klick auf Bild startet Texterkennung und Übersetzung
    });
})();
